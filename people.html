<head>
  <!-- avoid text rendering issues on various platforms -->
  <meta charset="utf-8" />

  <!-- prevent auto-zooming on mobile browsers -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap for default styles and utility CSS classes -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome icons -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    rel="stylesheet"
  />

  <!-- Lodash utility library as _ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"></script>

  <!-- Vue 3 framework -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Pug template compiler -->
  <script src="https://pugjs.org/js/pug.js"></script>
  <script>
    window.pug = require("pug");

    function renderPug(str) {
      let indents = str.replace(/^\n/, "").match(/^\s+/);
      let indentRegex = new RegExp(`^${indents[0]}`, "gm");
      return pug.render(indents ? str.replace(indentRegex, "") : str);
    }

    // Utility function to truncate text with ellipsis
    function truncateText(text, maxLength = 100) {
      if (!text) return "";
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + "...";
    }
  </script>

  <!-- Ky HTTP client -->
  <script type="module">
    import ky from "https://cdn.skypack.dev/ky";

    window.ky = ky;
  </script>

  <!-- Custom styles for full height and scrollable columns -->
  <style>
    .scrollable-column {
      height: 100vh;
      overflow-y: auto;
    }

    /* Font size classes */
    .text-xs {
      font-size: 0.75rem;
    }

    .text-sm {
      font-size: 0.85rem;
    }

    .text-md {
      font-size: 0.95rem;
    }

    /* Animation for status changes - light blue */
    @keyframes highlight-fade-status {
      from {
        opacity: 0;
        background-color: #cce5ff;
      }
      to {
        opacity: 1;
        background-color: #cce5ff;
      }
    }

    /* Class for status changes */
    .highlight-fade-status {
      animation: highlight-fade-status 2s ease-in-out forwards;
    }

    /* Green fade for replies */
    .highlight-fade-reply {
      animation: highlight-fade-green 4s ease-in-out forwards;
    }

    @keyframes highlight-fade-green {
      0% {
        background-color: #66ff66; /* brighter green pop */
        box-shadow: 0 0 15px #33cc33; /* strong glow */
        transform: scale(1.02); /* slight "pop out" zoom */
      }
      30% {
        background-color: #b3ffb3;
        box-shadow: 0 0 8px #70db70;
        transform: scale(1.01);
      }
      100% {
        background-color: transparent;
        box-shadow: none;
        transform: scale(1);
      }
    }

    /* Yellow fade for unread */
    .highlight-fade-unread {
      animation: highlight-fade-yellow 4s ease-in-out forwards;
    }

    @keyframes highlight-fade-yellow {
      0% {
        background-color: #fff066; /* bright yellow pop */
        box-shadow: 0 0 15px #ffcc33; /* strong yellow glow */
        transform: scale(1.02);
      }
      30% {
        background-color: #fff4b3;
        box-shadow: 0 0 8px #ffeb70;
        transform: scale(1.01);
      }
      100% {
        background-color: transparent;
        box-shadow: none;
        transform: scale(1);
      }
    }

    .email-message {
      background-color: #fffacd; /* Light yellow */
      border-radius: 0.5rem;
    }

    .response-card {
      background-color: #d4edda !important; /* Light green */
      border-radius: 0.5rem;
    }

    .email-card-enter-from,
    .email-card-leave-to {
      max-height: 0;
      opacity: 0;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
    }

    .email-card-enter-to,
    .email-card-leave-from {
      max-height: 500px; /* Adjust as needed */
      opacity: 1;
    }

    .email-card-enter-active,
    .email-card-leave-active {
      transition: all 2s ease-in-out;
    }

    .response-card-enter-from,
    .response-card-leave-to {
      max-height: 0;
      opacity: 0;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      transform: translateY(-10px);
    }

    .response-card-enter-to,
    .response-card-leave-from {
      max-height: 200px; /* Adjust based on your content */
      opacity: 1;
      transform: translateY(0);
    }

    .response-card-enter-active,
    .response-card-leave-active {
      transition: all 0.5s ease-in-out;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="app"></div>
</body>

<script>
  function deepCamelCaseKeys(value) {
    if (_.isArray(value)) {
      return value.map(deepCamelCaseKeys);
    }
    if (_.isPlainObject(value)) {
      const camelKeyed = _.mapKeys(value, (v, k) => _.camelCase(k));
      return _.mapValues(camelKeyed, deepCamelCaseKeys);
    }
    return value;
  }

  async function fetchGetJson(url) {
    return deepCamelCaseKeys(await ky.get(url).json());
  }

  function reverseTimeCompare(a, b) {
    const timestampA = new Date(a.timestamp);
    const timestampB = new Date(b.timestamp);
    return timestampB - timestampA; // Sort in descending order (newest first)
  }

  function getFirstElement(arr) {
    return !_.isEmpty(arr) ? arr[0] : null;
  }

  function init() {
    const { createApp } = Vue;

    createApp({
      // Main HTML template but in PUG
      // language=pug
      template: renderPug(/* pug */ `
        div.container-fluid.h-100
          .row.h-100
            .col-12

              // Tab navigation
              ul.nav.nav-tabs.mt-3
                li.nav-item
                  a.nav-link.active(data-bs-toggle="tab" href="#first-tab")
                    | Candidates
                li.nav-item
                  a.nav-link(data-bs-toggle="tab" href="#second-tab")
                    | Emails
                li.nav-item
                  a.nav-link(data-bs-toggle="tab" href="#third-tab")
                    | SMS

              // Tab content
              .tab-content.h-100

                ///// First tab
                #first-tab.tab-pane.fade.show.active.h-100
                  .d-flex.flex-row
                    .d-flex.flex-column.overflow-auto(style="height: calc(100vh - 50px)")
                      .d-flex.flex-row.overflow-auto
                        .p-3
                          h1 Candidates
                            i.ms-2.fas.fa-laptop
                          .d-flex.flex-row.flex-wrap.gap-3
                            div.card(v-for="candidate in candidates" style="width: 18rem;" :key="candidate.candidateId")
                              .card-body
                                .h3 {{ candidate.name}}
                                div
                                    i.far.fa-envelope.me-2
                                    code {{ candidate.email }}
                                div
                                    i.fas.fa-phone-volume.me-2
                                    code {{ candidate.phone }}
                                div(:class="{ 'highlight-fade-status': candidate.statusChanged }")
                                    i(:class="candidate.status === 'Available' ? 'fas fa-check-square' : 'far fa-square'").me-2
                                    code {{ candidate.status }}
                                // Display the first unread email body (truncated) if available, otherwise show "no unread emails" message
                                div.border-top.pt-2.mt-2.highlight-fade-unread.text-xs(
                                    v-if="firstUnreadEmail(candidate)"
                                )
                                    i.far.fa-envelope-open.me-2
                                    span.text-muted Unread emails:
                                    span {{ truncateText(firstUnreadEmail(candidate)) }}
                                div.border-top.pt-2.mt-2.text-xs(
                                    v-if="!firstUnreadEmail(candidate)"
                                )
                                    i.far.fa-envelope-open.me-2
                                    span.text-muted Unread emails:
                                    span You have no unread emails

                                // Display the latest candidate email reply if available, otherwise show "You have no replies" message
                                div.border-top.pt-2.mt-2.highlight-fade-reply.text-xs(
                                    v-if="firstEmailReply(candidate)"
                                )
                                    i.far.fa-comment-dots.me-2
                                    span.text-muted Latest email reply:
                                    span {{ truncateText(firstEmailReply(candidate)) }}
                                div.border-top.pt-2.mt-2.text-xs(
                                    v-if="!firstEmailReply(candidate)"
                                )
                                    i.far.fa-comment-dots.me-2
                                    span.text-muted Latest email reply:
                                    span You have no email replies

                                // Display the first unread SMS body (truncated) if available, otherwise show "no unread SMS" message
                                div.border-top.pt-2.mt-2.highlight-fade-unread.text-xs(
                                    v-if="firstUnreadSms(candidate)"
                                )
                                    i.fas.fa-sms.me-2
                                    span.text-muted Unread SMS:
                                    span {{ truncateText(firstUnreadSms(candidate)) }}
                                div.border-top.pt-2.mt-2.text-xs(
                                    v-if="!firstUnreadSms(candidate)"
                                )
                                    i.fas.fa-sms.me-2
                                    span.text-muted Unread SMS:
                                    span You have no unread SMS

                                // Display the latest candidate SMS reply if available, otherwise show "You have no SMS replies" message
                                div.border-top.pt-2.mt-2.highlight-fade-reply.text-xs(
                                    v-if="firstSmsReply(candidate)"
                                )
                                    i.fas.fa-reply.me-2
                                    span.text-muted Latest SMS reply:
                                    span {{ truncateText(firstSmsReply(candidate)) }}
                                div.border-top.pt-2.mt-2.text-xs(
                                    v-if="!firstSmsReply(candidate)"
                                )
                                    i.fas.fa-reply.me-2
                                    span.text-muted Latest SMS reply:
                                    span You have no SMS replies

                ///// Second tab
                #second-tab.tab-pane.fade.h-100
                  .d-flex.flex-row
                    .d-flex.flex-column.overflow-auto(style="height: calc(100vh - 50px)")
                      .d-flex.flex-column.overflow-auto
                        .p-3
                          h1 Emails
                            i.ms-2.fas.fa-envelope
                          .d-flex.flex-column.gap-2
                            transition-group(name="email-card" tag="div" style="width: 100%;")
                              .card.mb-2(v-for="email in allEmails" :key="email.email_id" style="width: 100%;")
                                .card-body.py-2.text-md
                                  div.mb-1
                                    i.far.fa-user.me-2
                                    span Candidate: {{ getCandidateName(email.candidateId) }}
                                  div.mb-1
                                    i.far.fa-clock.me-2
                                    span {{ new Date(email.timestamp).toLocaleString() }}
                                  .card.email-message
                                    .card-body.py-2
                                      .h6.mb-1 {{ email.subject }}
                                      p.mb-1 {{ email.body }}
                                  transition(name="response-card")
                                    .card.response-card.mt-1(
                                      v-if="email.read && email.response"
                                    )
                                      .card-body.py-2
                                        .h6.mb-1 Response:
                                        p.mb-1 {{ email.response.text }}
                                        div
                                          i.far.fa-clock.me-2
                                          span {{ new Date(email.response.timestamp).toLocaleString() }}


                ///// Third tab
                #third-tab.tab-pane.fade.h-100
                  .d-flex.flex-row
                    .d-flex.flex-column.overflow-auto(style="height: calc(100vh - 50px)")
                      .d-flex.flex-column.overflow-auto
                        .p-3
                          h1 SMS
                            i.ms-2.fas.fa-sms
                          .d-flex.flex-column.gap-2
                            div.card.mb-2(v-for="sms in allSms" style="width: 100%;")
                              .card-body.py-2.text-md
                                div.mb-1
                                  i.far.fa-user.me-2
                                  span Candidate: {{ getCandidateName(sms.candidateId) }}
                                div.mb-1
                                  i.far.fa-clock.me-2
                                  span {{ new Date(sms.timestamp).toLocaleString() }}
                                div.mt-1
                                  p.mb-1.email-body {{ sms.body }}
                                transition(name="response-card")
                                  .card.response-card.mt-1(
                                    v-if="sms.read && sms.response"
                                  )
                                    .card-body.py-2
                                      .h6.mb-1 Response:
                                      p.mb-1.response-text {{ sms.response.text }}
                                      div
                                        i.far.fa-clock.me-2
                                        span {{ new Date(sms.response.timestamp).toLocaleString() }}
              `),

      // Variables available in the template
      data() {
        return {
          candidates: [],
          candidateUnreadEmails: {}, // Store unread emails for each candidate
          candidateReplies: {}, // Store candidate replies from read emails
          allEmails: [], // Store all emails for the Emails tab
          candidateUnreadSms: {}, // Store unread SMS for each candidate
          candidateSmsReplies: {}, // Store candidate replies from read SMS
          allSms: [], // Store all SMS for the SMS tab
          lastSeenReplies: {}, // { candidateId: "last reply text" }
          lastSeenSmsReplies: {},
        };
      },

      // Constructor called upon template instantiation
      async mounted() {
        this.candidates = await fetchGetJson("/candidates");

        // Refresh unread emails, candidate replies, and candidate status every second
        setInterval(this.fetchAll, 2000);
      },

      // Methods available in the template
      methods: {
        truncateText,

        async fetchAll() {
          await this.fetchAllEmails();
          await this.fetchCandidateStatus();
          await this.fetchAllSms();
        },

        async fetchCandidateStatus() {
          try {
            const updatedCandidates = await fetchGetJson("/candidates");
            for (const updatedCandidate of updatedCandidates) {
              const candidate = this.candidates.find(
                (c) => c.candidateId === updatedCandidate.candidateId,
              );
              if (candidate && candidate.status !== updatedCandidate.status) {
                console.log(
                  `Status of ${updatedCandidate.name}: ${candidate.status} -> ${updatedCandidate.status}`,
                );
                candidate.status = updatedCandidate.status;
                candidate.statusChanged = true;
                setTimeout(() => {
                  candidate.statusChanged = false;
                }, 3000);
              }
            }
          } catch (error) {
            console.error("Error fetching candidate status:", error);
          }
        },

        async fetchAllEmails() {
          try {
            const emails = await fetchGetJson("/emails");
            emails.sort(reverseTimeCompare);
            this.allEmails = emails;
            for (const candidate of this.candidates) {
              let id = candidate.candidateId;
              this.candidateUnreadEmails[id] = emails.filter(
                (e) => !e.read && e.candidateId === id,
              );
              const repliesEmails = emails.filter(
                (e) => e.read && e.response && e.candidateId === id,
              );
              this.candidateReplies[id] = repliesEmails.map(
                (e) => e.response.text,
              );
            }
          } catch (error) {
            console.error("Error fetching all emails:", error);
          }
        },

        async fetchAllSms() {
          try {
            const smsMessages = await fetchGetJson("/sms");
            smsMessages.sort(reverseTimeCompare);
            this.allSms = smsMessages;
            for (const candidate of this.candidates) {
              const id = candidate.candidateId;
              this.candidateUnreadSms[id] = smsMessages.filter(
                (s) => !s.read && s.candidateId === id,
              );
              const repliesSms = smsMessages.filter(
                (sms) => sms.read && sms.response && sms.candidateId === id,
              );
              repliesSms.sort(reverseTimeCompare);
              this.candidateSmsReplies[id] = repliesSms.map(
                (sms) => sms.response.text,
              );
            }
          } catch (error) {
            console.error("Error fetching all SMS messages:", error);
          }
        },

        getCandidateName(candidateId) {
          const candidate = this.candidates.find(
            (c) => c.candidateId === candidateId,
          );
          return candidate ? candidate.name : "Unknown Candidate";
        },

        firstUnreadEmail(candidate) {
          const unreadEmails =
            this.candidateUnreadEmails[candidate.candidateId];
          return getFirstElement(unreadEmails)?.body;
        },

        firstSmsReply(candidate) {
          const smsReplies = this.candidateSmsReplies[candidate.candidateId];
          return getFirstElement(smsReplies)?.response?.text;
        },

        firstUnreadSms(candidate) {
          const unreadSms = this.candidateUnreadSms[candidate.candidateId];
          return getFirstElement(unreadSms)?.body;
        },

        firstEmailReply(candidate) {
          const repliesEmails = this.candidateReplies[candidate.candidateId];
          return getFirstElement(repliesEmails)?.response?.text;
        },
      },
    }).mount("#app");
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
